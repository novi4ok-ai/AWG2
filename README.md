# AWG2
# Полная инструкция: Установка и настройка клиента AmneziaWG (AWG2) на Ubuntu 24.04 Server

В данной инструкции используется официальный PPA-репозиторий Amnezia (`ppa:amnezia/ppa`). Этот метод устанавливает актуальную версию протокола (`amneziawg-dkms` v1.0.0) в виде модуля ядра (kernel-space), что обеспечивает минимальные задержки и высокую производительность по сравнению с userspace-решениями.

## Шаг 1. Подготовка системы и установка зависимостей

Перед установкой модуля ядра необходимо обновить списки пакетов и установить `linux-headers` для текущей версии ядра. Это обязательное условие для корректной работы системы сборки DKMS.

```bash
# Обновляем списки пакетов
sudo apt update

# Устанавливаем базовые утилиты и заголовочные файлы ядра
sudo apt install -y software-properties-common linux-headers-$(uname -r) build-essential

```

## Шаг 2. Установка AmneziaWG

Добавляем официальный репозиторий и устанавливаем пакеты. Мета-пакет `amneziawg` автоматически установит консольные утилиты `amneziawg-tools` и соберет модуль ядра `amneziawg-dkms`.

```bash
# Добавляем официальный PPA-репозиторий
sudo add-apt-repository ppa:amnezia/ppa -y

# Обновляем кэш пакетов с учетом нового репозитория
sudo apt update

# Устанавливаем клиент
sudo apt install -y amneziawg

```

*Примечание: Предупреждения вида `Deprecated feature: REMAKE_INITRD` в процессе установки игнорируем — это нормальное поведение DKMS в Ubuntu 24.04.*

## Шаг 3. Подготовка конфигурации

Утилита `awg-quick` из официального пакета ищет конфигурации по специфичному пути: `/etc/amnezia/amneziawg/`.

```bash
# Создаем правильную структуру директорий
sudo mkdir -p /etc/amnezia/amneziawg

# Создаем файл конфигурации интерфейса awg0
sudo nano /etc/amnezia/amneziawg/awg0.conf

```

Вставь в этот файл конфигурацию, экспортированную из приложения AmneziaVPN.

**Важные проверки конфигурации (troubleshooting):**

1. **Мусорные параметры:** Если в конфиге есть строки вроде `I2=` или другие нестандартные параметры, которых нет в официальной документации WireGuard/AmneziaWG — **удали их**. Парсер `awg` выдаст ошибку `Line unrecognized`, если найдет неизвестный ключ. Оставь только стандартные ключи (Address, PrivateKey, PublicKey, Endpoint) и параметры обфускации от DPI (`Jc`, `Jmin`, `Jmax`, `S1`, `S2`, `H1`, `H2`, `H3`, `H4`).
2. **Настройка DNS:** Так как использование локального `amnezia-dns` отключено, убедись, что параметр `DNS` в секции `[Interface]` указывает на публичные серверы (например, `DNS = 1.1.1.1, 8.8.8.8`) или полностью закомментирован (`# DNS = ...`), чтобы сервер использовал системный резолвер.

```bash
# Ограничиваем права доступа к файлу (обязательно для безопасности PrivateKey)
sudo chmod 600 /etc/amnezia/amneziawg/awg0.conf

```

## Шаг 4. Ручной запуск и проверка

Поднимаем туннель для проверки маршрутизации и обфускации.

```bash
# Поднимаем VPN-интерфейс
sudo awg-quick up awg0

# Проверяем статус туннеля (ищем строки 'latest handshake' и 'transfer')
sudo awg show

# Проверяем, изменился ли внешний IP-адрес сервера
curl ifconfig.me

```

Если внешний IP изменился на IP твоего VPN-сервера и ошибок нет — интерфейс работает корректно. Опускаем его перед добавлением в автозагрузку:

```bash
# Опускаем интерфейс
sudo awg-quick down awg0

```

## Шаг 5. Настройка автозагрузки (systemd)

Для автоматического старта VPN при загрузке Ubuntu Server используем встроенный systemd-юнит. Имя службы формируется из названия конфигурационного файла (`awg0`).

```bash
# Добавляем службу в автозагрузку
sudo systemctl enable awg-quick@awg0

# Запускаем службу
sudo systemctl start awg-quick@awg0

# Проверяем статус (должно быть 'active')
sudo systemctl status awg-quick@awg0

# Автоматическая установка клиента AmneziaWG (AWG2)

Данный скрипт автоматизирует процесс установки и настройки клиента AmneziaWG (kernel-space реализация) на серверах под управлением Ubuntu.

## Основной функционал

* **Проверка окружения:** Валидирует запуск с правами `root` и принадлежность ОС к семейству Ubuntu.
* **Установка зависимостей:** Подключает официальный репозиторий `ppa:amnezia/ppa`, скачивает `linux-headers` и собирает модуль ядра через DKMS.
* **Интерактивная конфигурация:** Запрашивает содержимое `.conf` файла прямо в консоли (через STDIN) и автоматически вычищает невалидные параметры (например, артефакты `I2=`).
* **Автозагрузка (systemd):** Интегрирует интерфейс `awg0` в систему, создавая службу для автоматического поднятия туннеля при старте сервера.
* **Очистка (--clean):** Включает специальный флаг для быстрого отключения интерфейса и полного удаления созданных им правил маршрутизации (iptables/nftables) и конфигурационных файлов.
* **Локализация:** Выводит статусы выполнения операций на русском языке.

## Использование

Выдача прав на исполнение:

```bash
chmod +x install_awg.sh

```

**Запуск установки:**

```bash
sudo ./install_awg.sh

```

*(В процессе скрипт попросит вставить текст конфига и нажать `Ctrl+D`)*

**Вызов справки:**

```bash
sudo ./install_awg.sh -h

```

**Остановка туннеля и удаление всех правил/конфигов:**

```bash
sudo ./install_awg.sh -c

```
